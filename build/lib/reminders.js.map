{"version":3,"sources":["../../src/lib/reminders.js"],"names":["notifications","require","main","posts","meta","user","emailer","nconf","winston","p","promisify","createNotif","create","pushNotif","push","getPostFields","getUidsFromSet","sendEmail","send","getUserSettings","getSettings","getUserFields","emailNotification","uid","event","message","parseInt","config","disableEmailSubscriptions","all","pid","day","userData","userSettings","response","sendPostNotifications","parsed","responses","content","isEmail","subject","title","name","replace","site_title","username","userslug","url","get","base_url","notify","reminder","uids","mandatory","users","selection","yes","maybe","map","u","postData","notif","bodyShort","bodyLong","nid","tid","from","path","initNotifierDaemon","checkingInterval","verbose","Math","floor","lastEnd","Date","now","checkReminders","start","end","events","occurences","reduce","prev","max","reminders","repeats","filtered","find","r","remDate","startDate","Number","isFinite","filter","Boolean","daemon","asCallback","err","error","setTimeout"],"mappings":"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","file":"reminders.js","sourcesContent":["// import { fork } from 'child_process';\r\nimport Promise from 'bluebird';\r\nimport { getAll as getResponses, getUserResponse } from './responses';\r\nimport { getEventsEndingAfter, escapeEvent } from './event';\r\nimport { filterUidsByPid } from './privileges';\r\nimport { getOccurencesOfRepetition } from './repetition';\r\nimport { eventTemplate } from './templates';\r\nimport { getSetting } from './settings';\r\n\r\nconst notifications = require.main.require('./src/notifications');\r\nconst posts = require.main.require('./src/posts');\r\nconst meta = require.main.require('./src/meta');\r\nconst user = require.main.require('./src/user');\r\nconst emailer = require.main.require('./src/emailer');\r\nconst nconf = require.main.require('nconf');\r\nconst winston = require.main.require('winston');\r\n\r\nconst p = Promise.promisify;\r\n\r\nconst createNotif = p(notifications.create);\r\nconst pushNotif = p(notifications.push);\r\nconst getPostFields = p(posts.getPostFields);\r\nconst getUidsFromSet = p(user.getUidsFromSet);\r\nconst sendEmail = p(emailer.send);\r\nconst getUserSettings = p(user.getSettings);\r\nconst getUserFields = p(user.getUserFields);\r\n\r\nconst emailNotification = async ({ uid, event, message }) => {\r\n  if (parseInt(meta.config.disableEmailSubscriptions, 10) === 1) {\r\n    return;\r\n  }\r\n\r\n  const [userData, userSettings, response] = await Promise.all([\r\n    getUserFields(uid, ['username', 'userslug']),\r\n    getUserSettings(uid),\r\n    getUserResponse({ pid: event.pid, uid, day: event.day }),\r\n  ]);\r\n\r\n  if (userSettings.sendPostNotifications) {\r\n    const parsed = await escapeEvent(event);\r\n    parsed.responses = {\r\n      [uid]: response,\r\n    };\r\n\r\n    const content = eventTemplate({ event: parsed, uid, isEmail: true });\r\n\r\n    await sendEmail('notif_plugin_calendar_event_reminder', uid, {\r\n      pid: event.pid,\r\n      subject: `[${meta.config.title || 'NodeBB'}] ` +\r\n        `[[calendar:event_starting, ${message}, ${event.name}]]`,\r\n      content: content.replace(/\"\\/\\//g, '\"https://'),\r\n      site_title: meta.config.title || 'NodeBB',\r\n      username: userData.username,\r\n      userslug: userData.userslug,\r\n      url: `${nconf.get('url')}/post/${event.pid}`,\r\n      base_url: nconf.get('url'),\r\n    });\r\n  }\r\n};\r\n\r\nconst notify = async ({ event, reminder, message }) => {\r\n  let uids;\r\n\r\n  // if event is mandatory, notify all the users who can view it\r\n  if (event.mandatory) {\r\n    const all = await getUidsFromSet('users:joindate', 0, -1);\r\n    uids = await filterUidsByPid(all, event.pid);\r\n  } else {\r\n    let users;\r\n\r\n    // if reminder is for the event start\r\n    // notify 'maybe' and 'yes' responders\r\n    // otherwise, notify only 'yes' responders\r\n    if (reminder === 0) {\r\n      const responses = await getResponses({\r\n        pid: event.pid,\r\n        selection: ['yes', 'maybe'],\r\n      });\r\n      users = [...responses.yes, ...responses.maybe];\r\n    } else {\r\n      const responses = await getResponses({\r\n        pid: event.pid,\r\n        selection: ['yes'],\r\n      });\r\n      users = responses.yes;\r\n    }\r\n    uids = users.map(u => u.uid);\r\n  }\r\n\r\n  const postData = await getPostFields(event.pid, ['tid', 'content', 'title']);\r\n\r\n  const notif = await createNotif({\r\n    bodyShort: `[[calendar:event_starting, ${message}, ${event.name}]]`,\r\n    bodyLong: postData.content,\r\n    nid: `plugin-calendar:events:pid:${event.pid}:event_starting`,\r\n    pid: event.pid,\r\n    tid: postData.tid,\r\n    from: event.uid,\r\n    path: `/post/${event.pid}`,\r\n  });\r\n  await pushNotif(notif, uids);\r\n\r\n  await Promise.all(uids.map(uid =>\r\n    emailNotification({ uid, event, message, postData })\r\n  ));\r\n};\r\n\r\nconst initNotifierDaemon = async () => {\r\n  // ms between checking for reminders\r\n  // pulled from settings\r\n  let checkingInterval = await getSetting('checkingInterval');\r\n\r\n  winston.verbose(`Notifier Daemon initialized with\r\n    interval of ${Math.floor(checkingInterval / 1000)} seconds`);\r\n\r\n  let lastEnd = Date.now() + checkingInterval;\r\n\r\n  const checkReminders = async () => {\r\n    checkingInterval = await getSetting('checkingInterval');\r\n    // timespan we check is a checkingInterval in the future\r\n    // so as to avoid sending notifications too late\r\n    const start = lastEnd;\r\n    const end = Date.now() + checkingInterval;\r\n    lastEnd = end;\r\n\r\n    const events = await getEventsEndingAfter(start);\r\n\r\n    const occurences = events.reduce((prev, event) => {\r\n      const max = Math.max(0, ...event.reminders);\r\n      if (event.repeats) {\r\n        return [...prev, ...getOccurencesOfRepetition(event, start, end + max)];\r\n      }\r\n      return [...prev, event];\r\n    }, []);\r\n\r\n    const filtered = occurences\r\n      .map((event) => {\r\n        const reminder = [0, ...event.reminders].find((r) => {\r\n          const remDate = event.startDate - r;\r\n          return remDate > start && remDate <= end;\r\n        });\r\n        if (!Number.isFinite(reminder)) {\r\n          return null;\r\n        }\r\n        const message = `[[moment:time-in, ${event.startDate - start}]]`;\r\n        return { event, reminder, message };\r\n      })\r\n      .filter(Boolean);\r\n\r\n    await Promise.all(filtered.map(notify));\r\n  };\r\n\r\n  const daemon = () => {\r\n    checkReminders().asCallback((err) => {\r\n      if (err) {\r\n        winston.error(err);\r\n      }\r\n      setTimeout(daemon, checkingInterval);\r\n    });\r\n  };\r\n  daemon();\r\n};\r\n\r\nexport { initNotifierDaemon, notify };\r\n"]}