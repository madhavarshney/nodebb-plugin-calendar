{"version":3,"sources":["../../src/lib/controllers.js"],"names":["privileges","require","main","categories","p","promisify","getAllCategoryFields","filterCids","shadeColor2","color","percent","f","parseInt","slice","t","R","G","B","Math","round","toString","router","middleware","renderAdmin","req","res","next","then","settings","render","catch","get","admin","buildHeader","resolve","JSON","parse","query","sendStatus","renderPage","cb","err","data","uid","cats","filtered","map","c","cid","colors","filter","includes","style","bgColor","params","pid","eventPid","day","eventDay","calendarEventsStyle","join","title","eventJSON","raw","event","repeats","startDate","endDate","occurenceDate","Date","s","setUTCFullYear","getUTCFullYear","setUTCDate","getUTCDate","setUTCMonth","getUTCMonth","valueOf","responses","eventData","stringify","eventHTML","asCallback"],"mappings":"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","file":"controllers.js","sourcesContent":["import Promise from 'bluebird';\r\nimport { getEvent, escapeEvent } from './event';\r\nimport { canViewPost } from './privileges';\r\nimport { eventTemplate } from './templates';\r\nimport { getUserResponse } from './responses';\r\nimport { getSettings, setSettings } from './settings';\r\n\r\nconst privileges = require.main.require('./src/privileges');\r\nconst categories = require.main.require('./src/categories');\r\n\r\nconst p = Promise.promisify;\r\n\r\nconst getAllCategoryFields = p(categories.getAllCategoryFields);\r\nconst filterCids = p(privileges.categories.filterCids);\r\n\r\n/* eslint-disable */\r\nfunction shadeColor2(color, percent) {\r\n  var f=parseInt(color.slice(1),16),t=percent<0?0:255,p=percent<0?percent*-1:percent,R=f>>16,G=f>>8&0x00FF,B=f&0x0000FF;\r\n  return \"#\"+(0x1000000+(Math.round((t-R)*p)+R)*0x10000+(Math.round((t-G)*p)+G)*0x100+(Math.round((t-B)*p)+B)).toString(16).slice(1);\r\n}\r\n/* eslint-enable */\r\n\r\nexport default (router, middleware) => {\r\n  const renderAdmin = (req, res, next) => {\r\n    getSettings().then((settings) => {\r\n      res.render('admin/plugins/calendar', {\r\n        settings,\r\n      });\r\n    }).catch(next);\r\n  };\r\n  router.get('/admin/plugins/calendar', middleware.admin.buildHeader, renderAdmin);\r\n  router.get('/api/admin/plugins/calendar', renderAdmin);\r\n\r\n  router.get('/api/admin/plugins/calendar/save', (req, res, next) => {\r\n    Promise.resolve()\r\n      .then(() => setSettings(JSON.parse(req.query.settings)))\r\n      .then(() => {\r\n        res.sendStatus(200);\r\n      })\r\n      .catch(next);\r\n  });\r\n\r\n  const renderPage = (req, res, next) => {\r\n    const cb = (err, data) => {\r\n      if (err) {\r\n        next(err);\r\n        return;\r\n      }\r\n      res.render('calendar', data);\r\n    };\r\n\r\n    // not using server rendering for events because it could be a lot of info\r\n    // better to have a fast page load time\r\n\r\n    (async () => {\r\n      const uid = req.uid;\r\n      const cats = await getAllCategoryFields(['cid', 'bgColor']);\r\n      const filtered = await filterCids('read', cats.map(c => c.cid), uid);\r\n\r\n      const colors = cats.filter(c => filtered.includes(c.cid));\r\n\r\n      const style = colors.map(({ cid, bgColor }) => `\r\n        .plugin-calendar-cal-event-category-${cid} {\r\n        background-color: ${bgColor}CC !important;\r\n        border-color: ${shadeColor2(bgColor, -0.2)} !important;\r\n      }`);\r\n\r\n      const { eventPid: pid, eventDay: day } = req.params;\r\n\r\n      if (!pid || !(await canViewPost(pid, uid))) {\r\n        return {\r\n          calendarEventsStyle: style.join('\\n'),\r\n          title: '[[calendar:calendar]]',\r\n          eventJSON: 'null',\r\n        };\r\n      }\r\n\r\n      const raw = await getEvent(pid);\r\n      const event = await escapeEvent(raw);\r\n      event.day = day || null;\r\n\r\n      if (event.repeats && event.day) {\r\n        const { startDate, endDate } = event;\r\n        const occurenceDate = new Date(day);\r\n        const s = new Date(startDate);\r\n\r\n        s.setUTCFullYear(occurenceDate.getUTCFullYear());\r\n        s.setUTCDate(occurenceDate.getUTCDate());\r\n        s.setUTCMonth(occurenceDate.getUTCMonth());\r\n\r\n        event.startDate = s.valueOf();\r\n        event.endDate = event.startDate + (endDate - startDate);\r\n      }\r\n\r\n      event.responses = {\r\n        [uid]: await getUserResponse({ pid, day, uid }),\r\n      };\r\n\r\n      return {\r\n        calendarEventsStyle: style.join('\\n'),\r\n        title: '[[calendar:calendar]]',\r\n        eventData: event,\r\n        eventJSON: JSON.stringify(event),\r\n        eventHTML: eventTemplate({ event, uid }),\r\n      };\r\n    })().asCallback(cb);\r\n  };\r\n\r\n  router.get('/calendar/event/:eventPid/:eventDay', middleware.buildHeader, renderPage);\r\n  router.get('/api/calendar/event/:eventPid/:eventDay', renderPage);\r\n  router.get('/calendar/event/:eventPid', middleware.buildHeader, renderPage);\r\n  router.get('/api/calendar/event/:eventPid', renderPage);\r\n  router.get('/calendar', middleware.buildHeader, renderPage);\r\n  router.get('/api/calendar', renderPage);\r\n};\r\n"]}