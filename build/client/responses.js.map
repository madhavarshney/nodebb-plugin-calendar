{"version":3,"sources":["../../src/client/responses.js"],"names":["userTemplate","user","config","relative_path","userslug","picture","username","noYesResponses","noMaybeResponses","noNoResponses","addResponsesToPost","pid","cb","$responses","$","day","attr","length","socket","emit","err","responses","message","app","alertError","yes","maybe","no","yess","find","maybes","nos","map","empty","append","setupDTP","dayInput","m","utc","datetimepicker","icons","time","date","up","down","previous","next","today","clear","close","allowInputToggle","locale","userLang","defaultLang","toLowerCase","replace","format","useCurrent","data","noop","setupPost","e","buttonCont","closest","uid","remove","value","button","siblings","removeClass","addClass","initResponses","document","body","on","target","alertSuccess","input","checkPosts","posts","post","ajaxify","setTimeout","forEach","notLoaded","is","parseInt","toggle","panel","cont","height","children","scrollHeight","css","toggleClass","window","join","requirejs","translator","translate","translated","text","split"],"mappings":"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","file":"responses.js","sourcesContent":["import moment from 'moment';\r\n\r\nconst userTemplate = user => (`\r\n  <li class=\"icon pull-left\">\r\n    <a href=\"${config.relative_path}/user/${user.userslug}\">\r\n      ${user.picture ? `\r\n      <img title=\"${user.username}\" class=\"img-rounded user-img not-responsive\"\r\n        src=\"${user.picture}\">\r\n      ` : `\r\n      <div class=\"user-icon user-img\" style=\"background-color: ${user['icon:bgColor']};\"\r\n        title=\"${user.username}\">${user['icon:text']}</div>\r\n      `}\r\n    </a>\r\n  </li>\r\n`);\r\n\r\nlet noYesResponses;\r\nlet noMaybeResponses;\r\nlet noNoResponses;\r\n\r\nconst addResponsesToPost = (pid, cb) => {\r\n  const $responses = $(`[data-pid=${pid}] .plugin-calendar-event-responses-lists`);\r\n  const day = $(`[data-pid=${pid}] [data-day]`).attr('data-day');\r\n\r\n  if (!$responses.length) {\r\n    return;\r\n  }\r\n\r\n  socket.emit('plugins.calendar.getResponses', { pid, day }, (err, responses) => {\r\n    if (err) {\r\n      if (err.message) {\r\n        app.alertError(err);\r\n      }\r\n      throw err;\r\n    }\r\n    if (!responses ||\r\n    !responses.yes ||\r\n    !responses.maybe ||\r\n    !responses.no) {\r\n      return;\r\n    }\r\n\r\n    const yess = $responses.find('.plugin-calendar-event-responses-list-yes');\r\n    const maybes = $responses.find('.plugin-calendar-event-responses-list-maybe');\r\n    const nos = $responses.find('.plugin-calendar-event-responses-list-no');\r\n\r\n    const yes = responses.yes.map(userTemplate);\r\n    const maybe = responses.maybe.map(userTemplate);\r\n    const no = responses.no.map(userTemplate);\r\n\r\n    yess.empty().append(yes.length ? yes : noYesResponses);\r\n    maybes.empty().append(maybe.length ? maybe : noMaybeResponses);\r\n    nos.empty().append(no.length ? no : noNoResponses);\r\n\r\n    cb();\r\n  });\r\n};\r\n\r\nconst setupDTP = (responses, day) => {\r\n  const dayInput = responses.find('.plugin-calendar-event-responses-day input');\r\n  if (!dayInput.length) {\r\n    return;\r\n  }\r\n  const m = day ? moment.utc(day) : moment();\r\n\r\n  dayInput.datetimepicker({\r\n    icons: {\r\n      time: 'fa fa-clock-o',\r\n      date: 'fa fa-calendar',\r\n      up: 'fa fa-arrow-up',\r\n      down: 'fa fa-arrow-down',\r\n      previous: 'fa fa-arrow-left',\r\n      next: 'fa fa-arrow-right',\r\n      today: 'fa fa-crosshairs',\r\n      clear: 'fa fa-trash',\r\n      close: 'fa fa-times',\r\n    },\r\n    allowInputToggle: true,\r\n    locale: (config.userLang || config.defaultLang).toLowerCase().replace(/_/g, '-'),\r\n    format: 'L',\r\n    useCurrent: true,\r\n  })\r\n  .data('DateTimePicker')\r\n  .date(m);\r\n};\r\n\r\nconst noop = () => {};\r\n\r\nconst setupPost = ({ pid, e }, cb = noop) => {\r\n  let buttonCont = $(`[data-pid=${pid}] .plugin-calendar-event-responses-user`);\r\n  const responses = buttonCont.closest('[data-day]');\r\n  const day = responses.attr('data-day') || null;\r\n\r\n  if (!buttonCont.length) {\r\n    cb();\r\n    return;\r\n  }\r\n\r\n  if (!app.user.uid) {\r\n    buttonCont.remove();\r\n    cb();\r\n    return;\r\n  }\r\n\r\n  if (!e) {\r\n    setupDTP(responses, day);\r\n  }\r\n\r\n  socket.emit('plugins.calendar.getUserResponse', { pid, day }, (err, value) => {\r\n    if (err) {\r\n      app.alertError(err);\r\n      throw err;\r\n    }\r\n\r\n    buttonCont = $(`[data-pid=${pid}] .plugin-calendar-event-responses-user`);\r\n    const button = buttonCont.find(`[data-value=${value || 'no'}]`);\r\n\r\n    button.siblings().removeClass('active');\r\n    button.addClass('active');\r\n\r\n    cb();\r\n  });\r\n};\r\n\r\nconst initResponses = () => {\r\n  $(document.body).on('click', '.plugin-calendar-event-responses-user .btn', (e) => {\r\n    const button = $(e.target);\r\n    const value = button.data('value');\r\n    const pid = button.closest('[data-pid]').attr('data-pid');\r\n    const day = button.closest('[data-day]').attr('data-day');\r\n\r\n    socket.emit('plugins.calendar.submitResponse', { pid, value, day }, (err) => {\r\n      if (err) {\r\n        if (err.message) {\r\n          app.alertError(err);\r\n        }\r\n        throw err;\r\n      }\r\n      app.alertSuccess();\r\n      button.siblings().removeClass('active');\r\n      button.addClass('active');\r\n    });\r\n  });\r\n\r\n  $(document.body).on('change dp.change', '.plugin-calendar-event-responses-day input', (e) => {\r\n    const input = $(e.target);\r\n    const day = input\r\n      .data('DateTimePicker').date()\r\n      .utc()\r\n      .format('YYYY-MM-DD');\r\n    const pid = input.closest('[data-pid]').attr('data-pid');\r\n    const responses = input.closest('[data-day]');\r\n    responses.attr('data-day', day);\r\n\r\n    responses\r\n      .find('.plugin-calendar-event-responses-lists')\r\n      .attr('data-loaded', 'false')\r\n      .find('.panel')\r\n      .addClass('closed');\r\n\r\n    setupPost({ pid, e });\r\n  });\r\n\r\n  const checkPosts = (e, data) => {\r\n    const posts = data.posts || data.post || ajaxify.data.posts;\r\n\r\n    if (posts && posts.length > 0) {\r\n      setTimeout(() => {\r\n        posts.forEach(post => setupPost({ pid: post.pid }));\r\n      }, 200);\r\n    }\r\n  };\r\n\r\n  $(document.body).on(\r\n    'click',\r\n    '[data-pid] .plugin-calendar-event-responses-lists .panel-heading a',\r\n    (e) => {\r\n      const target = $(e.target).closest('a');\r\n      const notLoaded = target.is('[data-loaded=false] a');\r\n      const pid = parseInt(target.closest('[data-pid]').attr('data-pid'), 10);\r\n\r\n      const toggle = () => {\r\n        const panel = target.closest('.panel');\r\n        const cont = panel.find('.panel-collapse');\r\n        const height = cont.children()[0].scrollHeight;\r\n        cont.css('height', `${height}px`);\r\n        panel.toggleClass('closed');\r\n      };\r\n\r\n      if (notLoaded) {\r\n        addResponsesToPost(pid, toggle);\r\n        target\r\n          .closest('.plugin-calendar-event-responses-lists')\r\n          .attr('data-loaded', 'true');\r\n      } else {\r\n        toggle();\r\n      }\r\n    }\r\n  );\r\n\r\n  $(window).on([\r\n    'action:posts.loaded',\r\n    'action:ajaxify.end',\r\n    'action:posts.edited',\r\n  ].join(' '), checkPosts);\r\n  checkPosts(null, ajaxify.data);\r\n\r\n  window.requirejs(['translator'], (translator) => {\r\n    translator.translate(\r\n      '[[calendar:no_x_responses, [[calendar:response_yes]]]],' +\r\n      '[[calendar:no_x_responses, [[calendar:response_maybe]]]],' +\r\n      '[[calendar:no_x_responses, [[calendar:response_no]]]]',\r\n      (translated) => {\r\n        const text = translated.split(',');\r\n        noYesResponses = text[0];\r\n        noMaybeResponses = text[1];\r\n        noNoResponses = text[2];\r\n      }\r\n    );\r\n  });\r\n};\r\n\r\nexport default initResponses;\r\nexport { setupPost, setupDTP };\r\n"]}