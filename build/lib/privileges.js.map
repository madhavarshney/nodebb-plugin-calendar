{"version":3,"sources":["../../src/lib/privileges.js"],"names":["p","promisify","privileges","require","main","posts","privilegesPostCan","can","privilegesTopicCan","topics","filterUidsByCid","categories","filterUids","filterPids","filter","privilegeNames","canPost","canViewPost","pid","uid","canPostEvent","tid","getCidByPid","canRespond","then","respondIfCanReply","filterUidsByPid","uids","cid","filterByPid","events","map","e","filtered","includes","privilegesList","list","callback","privilegesGroupsList","privilegesListHuman","name"],"mappings":";;;;;;;;;;;AAAA;;;;AACA;;;;AAEA,MAAMA,IAAI,mBAAQC,SAAlB;;AAEA,MAAMC,aAAaC,QAAQC,IAAR,CAAaD,OAAb,CAAqB,kBAArB,CAAnB;AACA,MAAME,QAAQF,QAAQC,IAAR,CAAaD,OAAb,CAAqB,aAArB,CAAd;AACA,MAAMG,oBAAoBN,EAAEE,WAAWG,KAAX,CAAiBE,GAAnB,CAA1B;AACA,MAAMC,qBAAqBR,EAAEE,WAAWO,MAAX,CAAkBF,GAApB,CAA3B;AACA,MAAMG,kBAAkBV,EAAEE,WAAWS,UAAX,CAAsBC,UAAxB,CAAxB;AACA,MAAMC,aAAab,EAAEE,WAAWG,KAAX,CAAiBS,MAAnB,CAAnB;;AAEA,MAAMC,iBAAiB;AACrBC,WAAS;AADY,CAAvB;;AAIA,MAAMC,cAAc,CAACC,GAAD,EAAMC,GAAN,KAAcb,kBAAkB,MAAlB,EAA0BY,GAA1B,EAA+BC,GAA/B,CAAlC;AACA,MAAMC,eAAe,CAACC,GAAD,EAAMF,GAAN,KAAcX,mBAAmBO,eAAeC,OAAlC,EAA2CK,GAA3C,EAAgDF,GAAhD,CAAnC;AACA,MAAMG,cAActB,EAAEK,MAAMiB,WAAR,CAApB;;AAEA,MAAMC,aAAa,CAACL,GAAD,EAAMC,GAAN,KACjB,0BAAW,mBAAX,EACGK,IADH,CACSC,iBAAD,IAAuB;AAC3B,MAAIA,iBAAJ,EAAuB;AACrB,WAAOnB,kBAAkB,OAAlB,EAA2BY,GAA3B,EAAgCC,GAAhC,CAAP;AACD;AACD,SAAOF,YAAYC,GAAZ,EAAiBC,GAAjB,CAAP;AACD,CANH,CADF;;AASA,MAAMO,kBAAkB,CAACC,IAAD,EAAOT,GAAP,KACtBI,YAAYJ,GAAZ,EACCM,IADD,CACMI,OAAOlB,gBAAgB,MAAhB,EAAwBkB,GAAxB,EAA6BD,IAA7B,CADb,CADF;;AAIA,MAAME,cAAc,CAACC,MAAD,EAASX,GAAT,KAClBN,WAAW,MAAX,EAAmBiB,OAAOC,GAAP,CAAWC,KAAKA,EAAEd,GAAlB,CAAnB,EAA2CC,GAA3C,EACCK,IADD,CACMS,YAAYH,OAAOhB,MAAP,CAAckB,KAAKC,SAASC,QAAT,CAAkBF,EAAEd,GAApB,CAAnB,CADlB,CADF;;AAIA,MAAMiB,iBAAiB,CAACC,IAAD,EAAOC,QAAP,KACrBA,SAAS,IAAT,6CAAmBD,IAAnB,IAAyBrB,eAAeC,OAAxC,GADF;AAEA,MAAMsB,uBAAuB,CAACF,IAAD,EAAOC,QAAP,KAC3BA,SAAS,IAAT,6CAAmBD,IAAnB,IAA0B,UAASrB,eAAeC,OAAQ,EAA1D,GADF;AAEA,MAAMuB,sBAAsB,CAACH,IAAD,EAAOC,QAAP,KAC1BA,SAAS,IAAT,6CAAmBD,IAAnB,IAAyB,EAAEI,MAAM,aAAR,EAAzB,GADF;;QAIEvB,W,GAAAA,W;QACAG,Y,GAAAA,Y;QACAM,e,GAAAA,e;QACAS,c,GAAAA,c;QACAG,oB,GAAAA,oB;QACAC,mB,GAAAA,mB;QACAV,W,GAAAA,W;QACAN,U,GAAAA,U;QACAR,c,GAAAA,c","file":"privileges.js","sourcesContent":["import Promise from 'bluebird';\r\nimport { getSetting } from './settings';\r\n\r\nconst p = Promise.promisify;\r\n\r\nconst privileges = require.main.require('./src/privileges');\r\nconst posts = require.main.require('./src/posts');\r\nconst privilegesPostCan = p(privileges.posts.can);\r\nconst privilegesTopicCan = p(privileges.topics.can);\r\nconst filterUidsByCid = p(privileges.categories.filterUids);\r\nconst filterPids = p(privileges.posts.filter);\r\n\r\nconst privilegeNames = {\r\n  canPost: 'plugin_calendar:event:post',\r\n};\r\n\r\nconst canViewPost = (pid, uid) => privilegesPostCan('read', pid, uid);\r\nconst canPostEvent = (tid, uid) => privilegesTopicCan(privilegeNames.canPost, tid, uid);\r\nconst getCidByPid = p(posts.getCidByPid);\r\n\r\nconst canRespond = (pid, uid) =>\r\n  getSetting('respondIfCanReply')\r\n    .then((respondIfCanReply) => {\r\n      if (respondIfCanReply) {\r\n        return privilegesPostCan('reply', pid, uid);\r\n      }\r\n      return canViewPost(pid, uid);\r\n    });\r\n\r\nconst filterUidsByPid = (uids, pid) =>\r\n  getCidByPid(pid)\r\n  .then(cid => filterUidsByCid('read', cid, uids));\r\n\r\nconst filterByPid = (events, uid) =>\r\n  filterPids('read', events.map(e => e.pid), uid)\r\n  .then(filtered => events.filter(e => filtered.includes(e.pid)));\r\n\r\nconst privilegesList = (list, callback) =>\r\n  callback(null, [...list, privilegeNames.canPost]);\r\nconst privilegesGroupsList = (list, callback) =>\r\n  callback(null, [...list, `groups:${privilegeNames.canPost}`]);\r\nconst privilegesListHuman = (list, callback) =>\r\n  callback(null, [...list, { name: 'Post events' }]);\r\n\r\nexport {\r\n  canViewPost,\r\n  canPostEvent,\r\n  filterUidsByPid,\r\n  privilegesList,\r\n  privilegesGroupsList,\r\n  privilegesListHuman,\r\n  filterByPid,\r\n  canRespond,\r\n  privilegeNames,\r\n};\r\n"]}