{"version":3,"sources":["../../src/calendar/index.js"],"names":["queryRegExp","begin","momentLang","calendarOptions","editable","header","left","center","right","defaultView","themeSystem","lang","events","start","end","timezone","callback","socket","emit","startDate","valueOf","endDate","err","message","app","alertError","eventClick","e","original","pid","id","preventDefault","stopPropagation","repeats","ajaxify","updateHistory","day","shouldHandle","listen","state","data","prev","startsWith","current","url","init","$calendar","$","fullCalendar","$display","on","modal","matches","location","pathname","match","parseInt","el","getEventCache","find","x","event","history","replaceState","RELATIVE_PATH","window","calendarEventData","document","ready","__webpack_public_path__","config","userLang","defaultLang","toLowerCase","replace","require","split","er","Error"],"mappings":"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","file":"index.js","sourcesContent":["import 'fullcalendar';\r\nimport convertToFC from './convertToFC';\r\nimport displayEvent from './displayEvent';\r\nimport locationHistory from '../client/locationHistory';\r\nimport { setupDTP } from '../client/responses';\r\n\r\nconst queryRegExp = /calendar\\/?(?:\\/*event\\/+([0-9]+))?/;\r\n\r\nconst begin = (momentLang) => {\r\n  const calendarOptions = {\r\n    editable: false,\r\n    header: {\r\n      left: 'prev,next today',\r\n      center: 'title',\r\n      // right: 'month,agendaWeek,agendaDay',\r\n      right: 'listMonth,month,agendaWeek',\r\n    },\r\n    defaultView: 'listMonth',\r\n    themeSystem: 'bootstrap3',\r\n    lang: momentLang,\r\n    events: (start, end, timezone, callback) => {\r\n      socket.emit('plugins.calendar.getEventsByDate', {\r\n        startDate: start.valueOf(),\r\n        endDate: end.valueOf(),\r\n      }, (err, events) => {\r\n        if (err) {\r\n          if (err.message) {\r\n            app.alertError(err);\r\n          }\r\n          throw err;\r\n        }\r\n\r\n        callback(convertToFC(events));\r\n      });\r\n    },\r\n    eventClick: ({ original, id: pid }, e) => {\r\n      e.preventDefault();\r\n      e.stopPropagation();\r\n      displayEvent(original);\r\n      if (original.repeats) {\r\n        ajaxify.updateHistory(`calendar/event/${pid}/${original.day}`);\r\n      } else {\r\n        ajaxify.updateHistory(`calendar/event/${pid}`);\r\n      }\r\n    },\r\n    timezone: 'local',\r\n  };\r\n\r\n  let shouldHandle = false;\r\n\r\n  locationHistory.listen((state, data) => {\r\n    if (state.prev.startsWith('calendar') && state.current.startsWith('calendar')) {\r\n      data.url = null; // eslint-disable-line no-param-reassign\r\n      shouldHandle = true;\r\n    } else {\r\n      shouldHandle = false;\r\n    }\r\n  });\r\n\r\n  const init = () => {\r\n    const $calendar = $('#calendar');\r\n\r\n    if ($calendar && !shouldHandle) {\r\n      $calendar.fullCalendar(calendarOptions);\r\n      // const btn = $('#plugin-calendar-cal-only-yes');\r\n      // btn\r\n      //   .on('click', (e) => {\r\n      //     e.preventDefault();\r\n      //     $calendar.toggleClass('plugin-calendar-cal-only-yes');\r\n      //     btn.toggleClass('active');\r\n      //   })\r\n      //   .detach()\r\n      //   .appendTo($calendar.find('.fc-toolbar .fc-right'));\r\n    }\r\n\r\n    const $display = $('#plugin-calendar-cal-event-display');\r\n    if ($display) {\r\n      $display.on('click', '.dismiss', () => {\r\n        $display.modal('hide');\r\n        ajaxify.updateHistory('calendar');\r\n      });\r\n    }\r\n\r\n    const matches = location.pathname.match(queryRegExp);\r\n    const pid = matches && parseInt(matches[1], 10);\r\n    if (pid) {\r\n      const el = $calendar\r\n        .data('fullCalendar')\r\n        .getEventCache()\r\n        .find(x => x.id === pid);\r\n\r\n      if (shouldHandle) {\r\n        const event = el && el.original;\r\n        if (event) {\r\n          displayEvent(event);\r\n        } else {\r\n          history.replaceState({}, '', `${RELATIVE_PATH}/calendar`);\r\n        }\r\n      } else {\r\n        setupDTP($display.find('[data-day]'), window.calendarEventData.day);\r\n      }\r\n      $calendar.fullCalendar('gotoDate', el ? el.start : (\r\n        window.calendarEventData.day || window.calendarEventData.startDate\r\n      ));\r\n    } else if (shouldHandle) {\r\n      $display.modal('hide');\r\n    }\r\n  };\r\n\r\n  $(document).ready(init);\r\n  $(window).on('action:ajaxify.end', init);\r\n};\r\n\r\n__webpack_public_path__ = `${RELATIVE_PATH}/plugins/nodebb-plugin-calendar/bundles/`; // eslint-disable-line\r\n\r\nconst lang = config.userLang || config.defaultLang;\r\nconst momentLang = lang.toLowerCase().replace(/_/g, '-');\r\n\r\ntry {\r\n  if (momentLang === 'en-us') {\r\n    begin('en-us');\r\n  } else {\r\n    require(`fullcalendar/dist/locale/${momentLang}`)(() => { // eslint-disable-line\r\n      begin(momentLang);\r\n    });\r\n  }\r\n} catch (e) {\r\n  try {\r\n    require(`fullcalendar/dist/locale/${momentLang.split('-')[0]}`)(() => { // eslint-disable-line\r\n      begin(momentLang);\r\n    });\r\n  } catch (er) {\r\n    begin('en-us');\r\n    throw Error(`Could not load locale data (${momentLang}) for fullcalendar`);\r\n  }\r\n}\r\n"]}