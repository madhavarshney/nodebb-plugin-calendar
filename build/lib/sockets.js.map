{"version":3,"sources":["../../src/lib/sockets.js"],"names":["privileges","require","main","pluginSockets","posts","topics","p","promisify","can","categories","tidFromPid","pid","cb","getPostField","topicIsDeleted","tid","getTopicField","calendar","canPostEvent","sock","data","uid","cid","isMain","canPost","asCallback","getResponses","day","submitResponse","value","getUserResponse","getEventsByDate","startDate","endDate","events","filtered","occurences","reduce","prev","event","repeats","every","withResponses","all","map","catch","then","response","topicDeleted","escaped","responses","parseInt"],"mappings":"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","file":"sockets.js","sourcesContent":["import Promise from 'bluebird';\r\nimport { getAll as getAllResponses, submitResponse, getUserResponse } from './responses';\r\nimport { getEventsByDate, escapeEvent } from './event';\r\nimport { filterByPid, privilegeNames } from './privileges';\r\nimport { getOccurencesOfRepetition } from './repetition';\r\nimport { getSetting } from './settings';\r\n\r\nconst privileges = require.main.require('./src/privileges');\r\nconst pluginSockets = require.main.require('./src/socket.io/plugins');\r\nconst posts = require.main.require('./src/posts');\r\nconst topics = require.main.require('./src/topics');\r\n\r\nconst p = Promise.promisify;\r\n\r\nconst can = {\r\n  posts: p(privileges.posts.can),\r\n  topics: p(privileges.topics.can),\r\n  categories: p(privileges.categories.can),\r\n};\r\nconst tidFromPid = p((pid, cb) => posts.getPostField(pid, 'tid', cb));\r\nconst topicIsDeleted = p((tid, cb) => topics.getTopicField(tid, 'deleted', cb));\r\n\r\npluginSockets.calendar = {};\r\npluginSockets.calendar.canPostEvent = (sock, data, cb) => {\r\n  (async ({ uid }, { pid, tid, cid, isMain }) => {\r\n    if (!isMain && await getSetting('mainPostOnly')) {\r\n      return false;\r\n    }\r\n\r\n    if (pid) {\r\n      return can.posts(privilegeNames.canPost, pid, uid);\r\n    }\r\n    if (tid) {\r\n      return can.topics(privilegeNames.canPost, tid, uid);\r\n    }\r\n    if (cid) {\r\n      return can.categories(privilegeNames.canPost, cid, uid);\r\n    }\r\n    return false;\r\n  })(sock, data).asCallback(cb);\r\n};\r\n\r\npluginSockets.calendar.getResponses = ({ uid }, { pid, day }, cb) => {\r\n  getAllResponses({ uid, pid, day }).asCallback(cb);\r\n};\r\n\r\npluginSockets.calendar.submitResponse = ({ uid }, { pid, value, day } = {}, cb) => {\r\n  submitResponse({ uid, pid, value, day }).asCallback(cb);\r\n};\r\n\r\npluginSockets.calendar.getUserResponse = ({ uid }, { pid, day }, cb) => {\r\n  getUserResponse({ uid, pid, day }).asCallback(cb);\r\n};\r\n\r\npluginSockets.calendar.getEventsByDate = (sock, data, cb) => {\r\n  (async ({ uid }, { startDate, endDate }) => {\r\n    const events = await getEventsByDate(startDate, endDate);\r\n    const filtered = await filterByPid(events, uid);\r\n    const occurences = filtered.reduce((prev, event) => {\r\n      if (event.repeats && event.repeats.every) {\r\n        return [...prev, ...getOccurencesOfRepetition(event, startDate, endDate)];\r\n      }\r\n      return [...prev, event];\r\n    }, []);\r\n    const withResponses = await Promise.all(\r\n      occurences.map(async (event) => {\r\n        const day = event.day;\r\n        const [response, topicDeleted, escaped] = await Promise.all([\r\n          getUserResponse({ pid: event.pid, uid, day }).catch(() => null),\r\n          tidFromPid(event.pid).then(topicIsDeleted),\r\n          escapeEvent(event),\r\n        ]);\r\n        return {\r\n          ...escaped,\r\n          responses: {\r\n            [uid]: response,\r\n          },\r\n          topicDeleted: !!parseInt(topicDeleted, 10),\r\n        };\r\n      })\r\n    );\r\n\r\n    return withResponses;\r\n  })(sock, data).asCallback(cb);\r\n};\r\n"]}