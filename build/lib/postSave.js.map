{"version":3,"sources":["../../src/lib/postSave.js"],"names":["plugins","require","main","topics","winston","p","promisify","fireHook","getTopicField","isMainPost","pid","tid","mainPid","parseInt","postSave","data","post","event","content","match","existed","message","verbose","invalid","replace","failed","failures","obj","reduce","val","failure","isMain","can","uid","name","escape","location","trim","description","postSaveCallback","cb","asCallback"],"mappings":"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","file":"postSave.js","sourcesContent":["import validator from 'validator';\r\nimport Promise from 'bluebird';\r\nimport parse, { inPost } from './parse';\r\nimport { canPostEvent } from './privileges';\r\nimport { deleteEvent, saveEvent, eventExists, getEvent } from './event';\r\nimport validateEvent from './validateEvent';\r\nimport { notify } from './reminders';\r\nimport { getSetting } from './settings';\r\n\r\nconst plugins = require.main.require('./src/plugins');\r\nconst topics = require.main.require('./src/topics');\r\nconst winston = require.main.require('winston');\r\n\r\nconst p = Promise.promisify;\r\n\r\nconst fireHook = p(plugins.fireHook);\r\nconst getTopicField = p(topics.getTopicField);\r\n\r\nconst isMainPost = async ({ pid, tid }) => {\r\n  const mainPid = await getTopicField(tid, 'mainPid');\r\n  return parseInt(mainPid, 10) === parseInt(pid, 10);\r\n};\r\n\r\nconst postSave = async (data) => {\r\n  const { post } = data;\r\n  let event = parse(post.content);\r\n\r\n  // delete event if no longer in post\r\n  if (!post.content.match(inPost)) {\r\n    const existed = await eventExists(post.pid);\r\n    if (existed) {\r\n      await notify({\r\n        event: await getEvent(post.pid),\r\n        message: '[[calendar:event_deleted]]',\r\n      });\r\n\r\n      await deleteEvent(post.pid);\r\n      winston.verbose(`[plugin-calendar] Event (pid:${post.pid}) deleted`);\r\n    }\r\n\r\n    return data;\r\n  }\r\n\r\n  const invalid = () => {\r\n    post.content = post.content.replace(/\\[(\\/?)event\\]/g, '[$1event-invalid]');\r\n    return data;\r\n  };\r\n\r\n  if (!event) {\r\n    return invalid();\r\n  }\r\n\r\n  const [failed, failures] = validateEvent(event);\r\n  if (failed) {\r\n    const obj = failures.reduce((val, failure) => ({\r\n      ...val,\r\n      [failure]: event[failure],\r\n    }), {});\r\n    winston.verbose(`[plugin-calendar] Event (pid:${post.pid}) validation failed: `, obj);\r\n    return invalid();\r\n  }\r\n\r\n  const main = post.isMain || data.data.isMain || await isMainPost(post);\r\n  if (!main && await getSetting('mainPostOnly')) {\r\n    return invalid();\r\n  }\r\n\r\n  const can = await canPostEvent(post.tid, post.uid);\r\n  if (!can) {\r\n    return invalid();\r\n  }\r\n\r\n  event.name = validator.escape(event.name);\r\n  event.location = event.location.trim();\r\n  event.description = event.description.trim();\r\n  event.pid = post.pid;\r\n  event.uid = post.uid;\r\n  event = await fireHook('filter:plugin-calendar.event.post', event);\r\n\r\n  if (event) {\r\n    await saveEvent(event);\r\n    winston.verbose(`[plugin-calendar] Event (pid:${event.pid}) saved`);\r\n  }\r\n\r\n  return data;\r\n};\r\n\r\nconst postSaveCallback = (data, cb) => postSave(data).asCallback(cb);\r\n\r\nexport { postSave, postSaveCallback };\r\n"]}